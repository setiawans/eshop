<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Order Payment</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .payment-details {
            display: none;
            margin-top: 15px;
        }
    </style>
</head>

<body>
<div class="container my-4">
    <h2>Order Payment</h2>
    <div class="card">
        <div class="card-header">Order Details</div>
        <div class="card-body">
            <p>Order ID: <span th:text="${order.id}"></span></p>
            <p>Author: <span th:text="${order.author}"></span></p>
            <p>Order Time: <span th:text="${#dates.format(order.orderTime, 'yyyy-MM-dd HH:mm:ss')}"></span></p>
            <h4>Products</h4>
            <table class="table">
                <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Quantity</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="product : ${order.products}">
                    <td th:text="${product.productName}"></td>
                    <td th:text="${product.productQuantity}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <form th:action="@{/order/pay/{orderId}(orderId=${order.id})}" method="post" class="mt-3" id="paymentForm">
        <div class="form-group">
            <label>Payment Method</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" id="voucher" value="VOUCHER" required>
                <label class="form-check-label" for="voucher">Voucher</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" id="bank" value="TRANSFER_BANK" required>
                <label class="form-check-label" for="bank">Bank Transfer</label>
            </div>
        </div>

        <div id="voucherDetails" class="payment-details">
            <div class="form-group">
                <label for="voucherCode">Voucher Code</label>
                <input type="text" class="form-control" id="voucherCode" name="voucherCode" placeholder="Enter 16-digit voucher code" required>
                <small class="form-text text-muted">
                    Voucher code must:
                    <ul>
                        <li>Start with 'ESHOP'</li>
                        <li>Be exactly 16 characters long</li>
                        <li>Contain 8 digits</li>
                    </ul>
                </small>
            </div>
            <div id="voucherValidation" class="alert" style="display: none;"></div>
        </div>

        <div id="bankDetails" class="payment-details">
            <div class="form-group">
                <label for="bankName">Bank Name</label>
                <input type="text" class="form-control" id="bankName" name="bankName" placeholder="Enter Bank Name" required>
            </div>
            <div class="form-group">
                <label for="referenceCode">Reference Code</label>
                <input type="text" class="form-control" id="referenceCode" name="referenceCode" placeholder="Enter Reference Code" required>
            </div>
        </div>

        <button type="submit" class="btn btn-primary" id="submitPayment" disabled>Process Payment</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const paymentForm = document.getElementById('paymentForm');
        const voucherRadio = document.getElementById('voucher');
        const bankRadio = document.getElementById('bank');
        const voucherDetails = document.getElementById('voucherDetails');
        const bankDetails = document.getElementById('bankDetails');
        const voucherCode = document.getElementById('voucherCode');
        const bankNameInput = document.getElementById('bankName');
        const referenceCodeInput = document.getElementById('referenceCode');
        const voucherValidation = document.getElementById('voucherValidation');
        const submitPayment = document.getElementById('submitPayment');

        function togglePaymentDetails() {
            if (voucherRadio.checked) {
                voucherDetails.style.display = 'block';
                bankDetails.style.display = 'none';

                voucherCode.setAttribute('required', '');
                bankNameInput.removeAttribute('required');
                referenceCodeInput.removeAttribute('required');

                validateVoucherCode();
            } else if (bankRadio.checked) {
                voucherDetails.style.display = 'none';
                bankDetails.style.display = 'block';

                voucherCode.removeAttribute('required');
                bankNameInput.setAttribute('required', '');
                referenceCodeInput.setAttribute('required', '');

                validateBankDetails();
            }
        }

        function validateVoucherCode() {
            const code = voucherCode.value;
            const isValid = code.startsWith('ESHOP') &&
                code.length === 16 &&
                (code.match(/\d/g) || []).length === 8;

            voucherValidation.style.display = 'block';
            if (isValid) {
                voucherValidation.className = 'alert alert-success';
                voucherValidation.textContent = 'Valid voucher code!';
                submitPayment.disabled = false;
            } else {
                voucherValidation.className = 'alert alert-danger';
                voucherValidation.textContent = 'Invalid voucher code. Please check the requirements.';
                submitPayment.disabled = true;
            }
        }

        function validateBankDetails() {
            const bankNameValue = bankNameInput.value.trim();
            const referenceCodeValue = referenceCodeInput.value.trim();

            const isValid = bankNameValue.length > 0 && referenceCodeValue.length > 0;
            submitPayment.disabled = !isValid;
        }

        paymentForm.addEventListener('submit', function(event) {
            if (voucherRadio.checked) {
                const code = voucherCode.value;
                const isValid = code.startsWith('ESHOP') &&
                    code.length === 16 &&
                    (code.match(/\d/g) || []).length === 8;

                if (!isValid) {
                    event.preventDefault();
                    voucherValidation.className = 'alert alert-danger';
                    voucherValidation.textContent = 'Invalid voucher code. Please check the requirements.';
                    voucherValidation.style.display = 'block';
                }
            } else if (bankRadio.checked) {
                const bankNameValue = bankNameInput.value.trim();
                const referenceCodeValue = referenceCodeInput.value.trim();

                if (bankNameValue.length === 0 || referenceCodeValue.length === 0) {
                    event.preventDefault();
                }
            }
        });

        voucherRadio.addEventListener('change', togglePaymentDetails);
        bankRadio.addEventListener('change', togglePaymentDetails);
        voucherCode.addEventListener('input', validateVoucherCode);
        bankNameInput.addEventListener('input', validateBankDetails);
        referenceCodeInput.addEventListener('input', validateBankDetails);

        togglePaymentDetails();
    });
</script>
</body>
</html>